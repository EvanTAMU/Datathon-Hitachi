<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Trail - Document Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .nav-link.active {
            background-color: rgba(59, 130, 246, 0.2);
            font-weight: 600;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
            font-size: 0.8em;
        }
        .sort-icon.active {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-lg mb-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">üîí</span>
                    <span class="text-xl font-bold text-gray-800">Document Classifier</span>
                </div>
                <div class="flex space-x-1">
                    <a href="index.html" class="nav-link px-4 py-2 rounded-lg text-gray-700">
                        üì§ Upload
                    </a>
                    <a href="review.html" class="nav-link px-4 py-2 rounded-lg text-gray-700">
                        üîç Review Queue
                    </a>
                    <a href="audit.html" class="nav-link active px-4 py-2 rounded-lg text-gray-700">
                        üìã Audit Trail
                    </a>
                    <a href="insights.html" class="px-4 py-2 rounded-lg text-gray-700">
                        üß† Insights</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">üìã Audit Trail</h1>
                <button onclick="exportToCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    üì• Export CSV
                </button>
            </div>
            
            <!-- Filters -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Documents</label>
                    <input 
                        type="text" 
                        id="searchBox" 
                        placeholder="Search by filename..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Classification</label>
                    <select id="filterCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Categories</option>
                        <option value="Highly Sensitive">Highly Sensitive</option>
                        <option value="Confidential">Confidential</option>
                        <option value="Public">Public</option>
                        <option value="Unsafe">Unsafe</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Safety</label>
                    <select id="filterSafety" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Safety Levels</option>
                        <option value="safe">Safe</option>
                        <option value="unsafe">Unsafe</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <select id="filterDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>

            <!-- Statistics Summary -->
            <div id="summaryStats" class="mb-6 grid grid-cols-2 md:grid-cols-6 gap-4">
                <!-- Stats will be populated here -->
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead class="bg-gray-100 border-b-2 border-gray-300">
                        <tr>
                            <th class="sortable px-4 py-3 text-left text-sm font-semibold text-gray-700" onclick="sortTable('timestamp')">
                                Timestamp
                                <span class="sort-icon" id="sort-timestamp">‚Üï</span>
                            </th>
                            <th class="sortable px-4 py-3 text-left text-sm font-semibold text-gray-700" onclick="sortTable('document_name')">
                                Document
                                <span class="sort-icon" id="sort-document_name">‚Üï</span>
                            </th>
                            <th class="sortable px-4 py-3 text-left text-sm font-semibold text-gray-700" onclick="sortTable('classification')">
                                Classification
                                <span class="sort-icon" id="sort-classification">‚Üï</span>
                            </th>
                            <th class="sortable px-4 py-3 text-left text-sm font-semibold text-gray-700" onclick="sortTable('confidence')">
                                Confidence
                                <span class="sort-icon" id="sort-confidence">‚Üï</span>
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                Safety Status
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                Prompt Type
                            </th>
                            <th class="sortable px-4 py-3 text-left text-sm font-semibold text-gray-700" onclick="sortTable('user_id')">
                                User
                                <span class="sort-icon" id="sort-user_id">‚Üï</span>
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="auditTable">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-500">
                                Loading audit data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="mt-6 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> records
                </div>
                <div class="flex gap-2">
                    <button onclick="loadMore()" id="loadMoreBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Load More
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Classification Details</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let allData = [];
        let filteredData = [];
        let displayedData = [];
        let currentSort = { column: 'timestamp', direction: 'desc' };
        let itemsPerPage = 50;
        let currentPage = 1;

        // Load audit trail data
        async function loadAuditTrail() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/audit-trail?limit=500`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    allData = data.data;
                    applyFilters();
                    updateSummaryStats();
                }
            } catch (error) {
                console.error('Error loading audit trail:', error);
                document.getElementById('auditTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-red-500">
                            Error loading data. Please ensure the backend is running.
                        </td>
                    </tr>
                `;
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            const safetyFilter = document.getElementById('filterSafety').value;
            const dateFilter = document.getElementById('filterDate').value;

            filteredData = allData.filter(item => {
                const matchesSearch = item.document_name.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || item.classification === categoryFilter;
                
                let matchesSafety = true;
                if (safetyFilter) {
                    const details = parseDetails(item.details);
                    const isSafe = getSafetyStatus(details);
                    matchesSafety = (safetyFilter === 'safe' && isSafe) || (safetyFilter === 'unsafe' && !isSafe);
                }

                let matchesDate = true;
                if (dateFilter && item.timestamp) {
                    const itemDate = new Date(item.timestamp);
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    if (dateFilter === 'today') {
                        matchesDate = itemDate >= today;
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        matchesDate = itemDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        matchesDate = itemDate >= monthAgo;
                    }
                }

                return matchesSearch && matchesCategory && matchesSafety && matchesDate;
            });

            sortData();
            currentPage = 1;
            renderTable();
            updateCounts();
        }

        // Get safety status from details
        function getSafetyStatus(details) {
            if (!details) return true;
            
            const safetyAssessment = details.safety_assessment;
            if (!safetyAssessment) return true;
            
            return safetyAssessment.is_safe !== false && safetyAssessment.child_safe !== false;
        }

        // Get prompt type from details
        function getPromptType(details) {
            if (!details) return 'Standard';
            
            // Try to infer from reasoning or other fields
            const reasoning = (details.detailed_reasoning || details.reasoning || '').toLowerCase();
            
            if (reasoning.includes('pii') || reasoning.includes('social security')) {
                return 'PII-Focused';
            } else if (reasoning.includes('internal') || reasoning.includes('confidential')) {
                return 'Confidential';
            } else if (reasoning.includes('marketing') || reasoning.includes('public')) {
                return 'Public';
            } else if (reasoning.includes('technical') || reasoning.includes('proprietary')) {
                return 'Technical';
            } else if (reasoning.includes('military') || reasoning.includes('defense')) {
                return 'Safety-Aware';
            }
            
            return 'Standard';
        }

        // Sort data
        function sortData() {
            filteredData.sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                // Handle timestamp
                if (currentSort.column === 'timestamp') {
                    aVal = new Date(aVal || 0).getTime();
                    bVal = new Date(bVal || 0).getTime();
                }

                // Handle confidence (might be null)
                if (currentSort.column === 'confidence') {
                    aVal = aVal || 0;
                    bVal = bVal || 0;
                }

                // Handle strings
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }

                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        // Sort table
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active');
                icon.textContent = '‚Üï';
            });

            const icon = document.getElementById(`sort-${column}`);
            if (icon) {
                icon.classList.add('active');
                icon.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
            }

            sortData();
            currentPage = 1;
            renderTable();
        }

        // Render table
        function renderTable() {
            const start = 0;
            const end = currentPage * itemsPerPage;
            displayedData = filteredData.slice(start, end);

            const tbody = document.getElementById('auditTable');
            
            if (displayedData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            No records found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = displayedData.map(item => {
                const details = parseDetails(item.details);
                const isSafe = getSafetyStatus(details);
                const promptType = getPromptType(details);
                
                return `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-700">
                            ${formatDateTime(item.timestamp)}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700 font-medium max-w-xs truncate" title="${item.document_name}">
                            ${item.document_name}
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getCategoryClass(item.classification)}">
                                ${item.classification || 'N/A'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            ${item.confidence ? `
                                <div class="flex items-center gap-2">
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${(item.confidence * 100)}%"></div>
                                    </div>
                                    <span class="text-gray-700 text-xs">${(item.confidence * 100).toFixed(0)}%</span>
                                </div>
                            ` : '<span class="text-gray-400 text-xs">N/A</span>'}
                        </td>
                        <td class="px-4 py-3">
                            ${isSafe ? 
                                '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">‚úì Safe</span>' : 
                                '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">‚ö† Unsafe</span>'
                            }
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-xs px-2 py-1 bg-blue-50 text-blue-700 rounded">${promptType}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            ${item.user_id || 'System'}
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showDetails(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateCounts();
        }

        // Parse details JSON
        function parseDetails(detailsStr) {
            try {
                if (typeof detailsStr === 'string') {
                    return JSON.parse(detailsStr);
                }
                return detailsStr;
            } catch {
                return null;
            }
        }

        // Show details modal
        function showDetails(itemId) {
            const item = allData.find(i => i.id === itemId);
            if (!item) return;

            const details = parseDetails(item.details);
            const isSafe = getSafetyStatus(details);
            const promptType = getPromptType(details);

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Header Info -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 pb-4 border-b">
                        <div>
                            <p class="text-sm text-gray-600">Document Name</p>
                            <p class="font-semibold text-gray-900">${item.document_name}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Classification</p>
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${getCategoryClass(item.classification)}">
                                ${item.classification}
                            </span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Confidence</p>
                            <p class="font-semibold text-gray-900">${item.confidence ? (item.confidence * 100).toFixed(1) + '%' : 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Safety Status</p>
                            <p class="font-semibold ${isSafe ? 'text-green-600' : 'text-red-600'}">
                                ${isSafe ? '‚úì Safe' : '‚ö† Unsafe'}
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Prompt Type</p>
                            <span class="inline-block px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">${promptType}</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Timestamp</p>
                            <p class="font-semibold text-gray-900">${formatDateTime(item.timestamp)}</p>
                        </div>
                    </div>

                    ${details ? `
                        <!-- Reasoning -->
                        ${details.detailed_reasoning || details.reasoning ? `
                            <div>
                                <h3 class="font-semibold text-gray-800 mb-2">üìù Reasoning</h3>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-700">${details.detailed_reasoning || details.reasoning}</p>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Evidence -->
                        ${details.evidence && details.evidence.length > 0 ? `
                            <div>
                                <h3 class="font-semibold text-gray-800 mb-2">üîç Evidence</h3>
                                <div class="space-y-2">
                                    ${details.evidence.map(ev => `
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                            <p class="text-sm font-semibold text-blue-900">
                                                üìç Page ${ev.page} - ${ev.location}
                                            </p>
                                            <p class="text-sm text-gray-700 mt-1">${ev.finding}</p>
                                            <p class="text-xs text-gray-600 mt-1">Trigger: ${ev.category_trigger}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- PII Detected -->
                        ${details.pii_detected && Object.values(details.pii_detected).some(v => v === true || (Array.isArray(v) && v.length > 0)) ? `
                            <div>
                                <h3 class="font-semibold text-red-800 mb-2">üîí PII Detected</h3>
                                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <ul class="text-sm space-y-1">
                                        ${Object.entries(details.pii_detected)
                                            .filter(([k, v]) => v === true || (Array.isArray(v) && v.length > 0))
                                            .map(([key, value]) => `
                                                <li class="text-red-700">‚Ä¢ ${key.replace(/_/g, ' ').toUpperCase()}</li>
                                            `).join('')}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Safety Violations -->
                        ${details.safety_assessment?.violations?.length > 0 ? `
                            <div>
                                <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Safety Violations</h3>
                                <div class="bg-red-50 border border-red-200 rounded-lg p-3 space-y-2">
                                    ${details.safety_assessment.violations.map(v => `
                                        <div class="text-sm">
                                            <p class="font-semibold text-red-900">${v.type} (${v.severity})</p>
                                            <p class="text-red-700">${v.description}</p>
                                            <p class="text-xs text-gray-600 mt-1">Location: ${v.location}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Full JSON Details -->
                        <details class="border-t pt-4">
                            <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-blue-600">
                                View Full Classification Data (JSON)
                            </summary>
                            <pre class="mt-2 bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto max-h-96 text-xs">${JSON.stringify(details, null, 2)}</pre>
                        </details>
                    ` : '<p class="text-gray-500">No detailed classification data available.</p>'}
                </div>
            `;

            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        // Update summary statistics
        function updateSummaryStats() {
            const stats = {
                total: allData.length,
                'Highly Sensitive': 0,
                'Confidential': 0,
                'Public': 0,
                safe: 0,
                unsafe: 0
            };
            
            allData.forEach(item => {
                // Count by classification (only the 3 main categories)
                if (item.classification && item.classification !== 'Unsafe') {
                    stats[item.classification] = (stats[item.classification] || 0) + 1;
                }
                
                // Count by safety status
                const details = parseDetails(item.details);
                const isSafe = getSafetyStatus(details);
                
                if (isSafe) {
                    stats.safe++;
                } else {
                    stats.unsafe++;
                }
            });
            
            document.getElementById('summaryStats').innerHTML = `
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-600">Total</p>
                    <p class="text-2xl font-bold text-blue-600">${stats.total}</p>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-600">Highly Sensitive</p>
                    <p class="text-2xl font-bold text-red-600">${stats['Highly Sensitive'] || 0}</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-600">Confidential</p>
                    <p class="text-2xl font-bold text-orange-600">${stats['Confidential'] || 0}</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-600">Public</p>
                    <p class="text-2xl font-bold text-green-600">${stats['Public'] || 0}</p>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-600">‚ö† Unsafe Content</p>
                    <p class="text-2xl font-bold text-red-600">${stats.unsafe}</p>
                </div>
                <div class="bg-emerald-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-600">‚úì Safe Content</p>
                    <p class="text-2xl font-bold text-emerald-600">${stats.safe}</p>
                </div>
            `;
        }

        // Update counts
        function updateCounts() {
            document.getElementById('showingCount').textContent = displayedData.length;
            document.getElementById('totalCount').textContent = filteredData.length;
            
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (displayedData.length >= filteredData.length) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                loadMoreBtn.disabled = false;
                loadMoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Load more records
        function loadMore() {
            currentPage++;
            renderTable();
        }

        // Get category color class
        function getCategoryClass(category) {
            const classes = {
                'Highly Sensitive': 'bg-red-100 text-red-800',
                'Confidential': 'bg-orange-100 text-orange-800',
                'Public': 'bg-green-100 text-green-800',
                'Unsafe': 'bg-purple-100 text-purple-800'
            };
            return classes[category] || 'bg-gray-100 text-gray-800';
        }

        // Format date time
        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Export to CSV
        function exportToCSV() {
            const headers = ['Timestamp', 'Document', 'Classification', 'Confidence', 'Safety', 'Prompt Type', 'User'];
            const rows = filteredData.map(item => {
                const details = parseDetails(item.details);
                const isSafe = getSafetyStatus(details);
                const promptType = getPromptType(details);
                
                return [
                    formatDateTime(item.timestamp),
                    item.document_name,
                    item.classification || 'N/A',
                    item.confidence ? (item.confidence * 100).toFixed(1) + '%' : 'N/A',
                    isSafe ? 'Safe' : 'Unsafe',
                    promptType,
                    item.user_id || 'System'
                ];
            });

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-trail-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('searchBox').addEventListener('input', applyFilters);
        document.getElementById('filterCategory').addEventListener('change', applyFilters);
        document.getElementById('filterSafety').addEventListener('change', applyFilters);
        document.getElementById('filterDate').addEventListener('change', applyFilters);

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Close modal on background click
        document.getElementById('detailsModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailsModal') closeModal();
        });

        // Initial load with sort by timestamp descending
        loadAuditTrail();
        sortTable('timestamp'); // Start sorted by most recent
    </script>
</body>
</html>